{% extends "base.html" %}

{% block title %}LedgerFlow - Welcome{% endblock %}

{% block extra_css %}
<style>
    .onboarding-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 40px 20px;
    }
    
    .onboarding-step {
        display: none;
        animation: fadeInUp 0.6s ease-out;
    }
    
    .onboarding-step.active {
        display: block;
    }
    
    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 40px;
        gap: 12px;
    }
    
    .step-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #e2e8f0;
        transition: all 0.3s ease;
    }
    
    .step-dot.active {
        background: var(--primary-color);
        transform: scale(1.2);
    }
    
    .step-dot.completed {
        background: var(--success-color);
    }
    
    .welcome-card {
        text-align: center;
        padding: 60px 40px;
        background: var(--glass-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-card);
        backdrop-filter: var(--glass-blur);
    }
    
    .welcome-logo {
        font-size: 3rem;
        color: var(--primary-color);
        margin-bottom: 20px;
    }
    
    .welcome-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--secondary-color);
        margin-bottom: 16px;
        font-family: 'Montserrat', sans-serif;
    }
    
    .welcome-subtitle {
        font-size: 1.2rem;
        color: #64748b;
        margin-bottom: 40px;
        line-height: 1.6;
    }
    
    .stats-summary {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin: 30px 0;
        flex-wrap: wrap;
    }
    
    .stat-item {
        text-align: center;
        padding: 20px;
        background: rgba(255,255,255,0.6);
        border-radius: 16px;
        min-width: 120px;
    }
    
    .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary-color);
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #64748b;
        margin-top: 4px;
    }
    
    .company-form {
        background: var(--glass-bg);
        border-radius: var(--border-radius);
        padding: 40px;
        box-shadow: var(--shadow-card);
        backdrop-filter: var(--glass-blur);
    }
    
    .form-section {
        margin-bottom: 30px;
    }
    
    .form-section h3 {
        color: var(--secondary-color);
        margin-bottom: 20px;
        font-weight: 600;
    }
    
    .template-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }
    
    .template-card {
        background: var(--glass-bg);
        border: 2px solid transparent;
        border-radius: var(--border-radius);
        padding: 30px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: var(--glass-blur);
    }
    
    .template-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 32px rgba(37,99,235,0.15);
    }
    
    .template-card.selected {
        border-color: var(--primary-color);
        background: rgba(37,99,235,0.05);
    }
    
    .template-icon {
        font-size: 2.5rem;
        margin-bottom: 16px;
        color: var(--primary-color);
    }
    
    .template-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--secondary-color);
    }
    
    .template-description {
        font-size: 0.9rem;
        color: #64748b;
        line-height: 1.5;
    }
    
    .upload-area {
        border: 2px dashed #cbd5e1;
        border-radius: var(--border-radius);
        padding: 60px 20px;
        text-align: center;
        background: rgba(255,255,255,0.5);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .upload-area:hover,
    .upload-area.dragover {
        border-color: var(--primary-color);
        background: rgba(37,99,235,0.05);
    }
    
    .upload-icon {
        font-size: 3rem;
        color: #cbd5e1;
        margin-bottom: 20px;
    }
    
    .upload-text {
        font-size: 1.1rem;
        color: #64748b;
        margin-bottom: 10px;
    }
    
    .upload-hint {
        font-size: 0.9rem;
        color: #94a3b8;
    }
    
    .import-status {
        margin-top: 20px;
        padding: 20px;
        border-radius: 12px;
        display: none;
    }
    
    .import-status.success {
        background: rgba(34,197,94,0.1);
        border: 1px solid rgba(34,197,94,0.2);
        color: #166534;
    }
    
    .import-status.error {
        background: rgba(239,68,68,0.1);
        border: 1px solid rgba(239,68,68,0.2);
        color: #991b1b;
    }
    
    .navigation-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 40px;
        gap: 20px;
    }
    
    .btn-large {
        padding: 16px 40px;
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @media (max-width: 768px) {
        .onboarding-container {
            padding: 20px 10px;
        }
        
        .welcome-card {
            padding: 40px 20px;
        }
        
        .welcome-title {
            font-size: 2rem;
        }
        
        .stats-summary {
            gap: 20px;
        }
        
        .template-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="onboarding-container">
    <!-- Step Indicators -->
    <div class="step-indicator">
        <div class="step-dot active" data-step="1"></div>
        <div class="step-dot" data-step="2"></div>
        <div class="step-dot" data-step="3"></div>
        <div class="step-dot" data-step="4"></div>
    </div>

    <!-- Step 1: Welcome -->
    <div class="onboarding-step active" id="step-1">
        <div class="welcome-card">
            <div class="welcome-logo">
                <i class="fas fa-file-invoice"></i>
            </div>
            <h1 class="welcome-title">Welcome to LedgerFlow</h1>
            <p class="welcome-subtitle">Let's begin your invoice journey. We'll guide you through setting up your business and importing your first product catalog.</p>
            
            <div class="stats-summary" id="welcome-stats">
                <div class="stat-item">
                    <div class="stat-value">0</div>
                    <div class="stat-label">Invoices Generated</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">0</div>
                    <div class="stat-label">Products Imported</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">-</div>
                    <div class="stat-label">Last Template</div>
                </div>
            </div>
            
            <button class="btn btn-primary btn-large" onclick="nextStep()">
                <i class="fas fa-arrow-right"></i> Let's Begin
            </button>
        </div>
    </div>

    <!-- Step 2: Company Information -->
    <div class="onboarding-step" id="step-2">
        <div class="company-form">
            <h2 class="text-center mb-4">Tell us about your business</h2>
            <p class="text-center text-muted mb-4">This information will be used to generate professional invoices</p>
            
            <form id="company-form">
                <div class="form-section">
                    <h3>Required Information</h3>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="company-name" class="form-label">Company Name *</label>
                            <input type="text" class="form-control" id="company-name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="company-address" class="form-label">Company Address *</label>
                            <textarea class="form-control" id="company-address" rows="3" required></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Optional Information</h3>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="company-phone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="company-phone">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="company-email" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="company-email">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="company-gst" class="form-label">GST Number (India)</label>
                            <input type="text" class="form-control" id="company-gst">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="company-pin" class="form-label">PIN Code</label>
                            <input type="text" class="form-control" id="company-pin">
                        </div>
                    </div>
                </div>
            </form>
            
            <div class="navigation-buttons">
                <button class="btn btn-secondary" onclick="previousStep()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn btn-primary" onclick="saveCompanyInfo()">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Step 3: Choose Template -->
    <div class="onboarding-step" id="step-3">
        <div class="company-form">
            <h2 class="text-center mb-4">Choose your invoice template</h2>
            <p class="text-center text-muted mb-4">Select the template that matches your business requirements</p>
            
            <div class="template-grid">
                <div class="template-card" data-template="gst">
                    <div class="template-icon">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div class="template-title">GST Invoice (India)</div>
                    <div class="template-description">
                        Perfect for Indian businesses. Supports item-wise mixed GST rates (5%, 12%, 18%, 28%) with proper tax calculations and compliance.
                    </div>
                </div>
                
                <div class="template-card" data-template="plain">
                    <div class="template-icon">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div class="template-title">Plain Invoice (Cash)</div>
                    <div class="template-description">
                        Simple cash invoices with no tax logic. Ideal for local businesses, small shops, and cash transactions.
                    </div>
                </div>
                
                <div class="template-card" data-template="vat">
                    <div class="template-icon">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <div class="template-title">VAT Invoice (Bahrain)</div>
                    <div class="template-description">
                        Bahrain VAT compliant invoices. Supports 0% and 10% VAT rates with proper tax documentation.
                    </div>
                </div>
            </div>
            
            <div class="navigation-buttons">
                <button class="btn btn-secondary" onclick="previousStep()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn btn-primary" onclick="saveTemplateChoice()" id="template-next-btn" disabled>
                    Proceed to Import <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Step 4: Excel Import -->
    <div class="onboarding-step" id="step-4">
        <div class="company-form">
            <h2 class="text-center mb-4">Import your product catalog</h2>
            <p class="text-center text-muted mb-4">Upload your Excel file with product information</p>
            
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">Drag and drop your Excel file here</div>
                <div class="upload-hint">or click to browse files</div>
                <input type="file" id="excel-file" accept=".xlsx,.xls" style="display: none;">
            </div>
            
            <div class="import-status" id="import-status"></div>
            
            <div class="alert alert-info mt-4">
                <h5><i class="fas fa-info-circle"></i> Excel Format Requirements</h5>
                <ul class="mb-0">
                    <li><strong>Required columns:</strong> Product Name, SKU/HSN, Base Price</li>
                    <li><strong>Optional columns:</strong> Category, GST Rate, VAT Rate, Stock Qty</li>
                    <li>Download our template for the correct format</li>
                </ul>
            </div>
            
            <div class="navigation-buttons">
                <button class="btn btn-secondary" onclick="previousStep()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn btn-primary" onclick="proceedToGeneration()" id="proceed-btn" disabled>
                    Proceed to Generation <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStep = 1;
let selectedTemplate = null;
let uploadedFile = null;

// Initialize onboarding
document.addEventListener('DOMContentLoaded', function() {
    loadWelcomeStats();
    setupFileUpload();
    setupTemplateSelection();
});

function loadWelcomeStats() {
    // Load existing stats if any
    fetch('/api/onboarding/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector('#welcome-stats .stat-item:nth-child(1) .stat-value').textContent = data.invoices_generated || 0;
                document.querySelector('#welcome-stats .stat-item:nth-child(2) .stat-value').textContent = data.products_imported || 0;
                document.querySelector('#welcome-stats .stat-item:nth-child(3) .stat-value').textContent = data.last_template || '-';
            }
        })
        .catch(error => console.error('Error loading stats:', error));
}

function setupFileUpload() {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('excel-file');
    
    uploadArea.addEventListener('click', () => fileInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });
    
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
}

function setupTemplateSelection() {
    const templateCards = document.querySelectorAll('.template-card');
    templateCards.forEach(card => {
        card.addEventListener('click', () => {
            templateCards.forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedTemplate = card.dataset.template;
            document.getElementById('template-next-btn').disabled = false;
        });
    });
}

function handleFileSelect(file) {
    if (!file.name.match(/\.(xlsx|xls)$/)) {
        showImportStatus('Please select an Excel file (.xlsx or .xls)', 'error');
        return;
    }
    
    uploadedFile = file;
    document.getElementById('upload-area').innerHTML = `
        <div class="upload-icon text-success">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="upload-text">${file.name}</div>
        <div class="upload-hint">File selected successfully</div>
    `;
    
    // Auto-import the file
    importExcelFile(file);
}

function importExcelFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    showImportStatus('Importing products...', 'info');
    
    fetch('/api/products/import', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showImportStatus(`Successfully imported ${data.imported_count || 0} products!`, 'success');
            document.getElementById('proceed-btn').disabled = false;
        } else {
            showImportStatus(data.error || 'Import failed', 'error');
        }
    })
    .catch(error => {
        showImportStatus('Import failed: ' + error.message, 'error');
    });
}

function showImportStatus(message, type) {
    const statusDiv = document.getElementById('import-status');
    statusDiv.textContent = message;
    statusDiv.className = `import-status ${type}`;
    statusDiv.style.display = 'block';
}

function nextStep() {
    if (currentStep < 4) {
        showStep(currentStep + 1);
    }
}

function previousStep() {
    if (currentStep > 1) {
        showStep(currentStep - 1);
    }
}

function showStep(step) {
    // Hide all steps
    document.querySelectorAll('.onboarding-step').forEach(el => {
        el.classList.remove('active');
    });
    
    // Show current step
    document.getElementById(`step-${step}`).classList.add('active');
    
    // Update step indicators
    document.querySelectorAll('.step-dot').forEach((dot, index) => {
        dot.classList.remove('active', 'completed');
        if (index + 1 === step) {
            dot.classList.add('active');
        } else if (index + 1 < step) {
            dot.classList.add('completed');
        }
    });
    
    currentStep = step;
}

function saveCompanyInfo() {
    const form = document.getElementById('company-form');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const companyData = {
        name: document.getElementById('company-name').value,
        address: document.getElementById('company-address').value,
        phone: document.getElementById('company-phone').value,
        email: document.getElementById('company-email').value,
        gst: document.getElementById('company-gst').value,
        pin: document.getElementById('company-pin').value
    };
    
    fetch('/api/onboarding/company', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(companyData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            nextStep();
        } else {
            alert('Failed to save company information: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error saving company information: ' + error.message);
    });
}

function saveTemplateChoice() {
    if (!selectedTemplate) {
        alert('Please select a template');
        return;
    }
    
    fetch('/api/onboarding/template', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ template: selectedTemplate })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            nextStep();
        } else {
            alert('Failed to save template choice: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error saving template choice: ' + error.message);
    });
}

function proceedToGeneration() {
    // Complete onboarding and redirect to main dashboard
    fetch('/api/onboarding/complete', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '/';
        } else {
            alert('Failed to complete onboarding: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error completing onboarding: ' + error.message);
    });
}
</script>
{% endblock %} 